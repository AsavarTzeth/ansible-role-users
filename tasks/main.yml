---
- name: create groups
  group: name="{{ item.primary_group }}"
  when:
    - item.primary_group is defined
    - users_create_primary_group
  with_items: "{{ users }}"
  become: true
  no_log: true
  tags: users

- name: setup users
  user:
    name: "{{ item.name | mandatory }}"
    group:
      "{{ item.primary_group | default(omit)
      if users_create_primary_group else omit }}"
    groups: "{{ item.groups | default('') | join(',') }}"
    shell: "{{ item.shell | default(users_default_shell) }}"
    password:
      "{{ item.passwd | password_hash('sha512',item.passwd_salt)
      if item.passwd is defined and item.passwd_salt is defined else omit }}"
    comment: "{{ item.gecos | default(omit) }}"
    state: "{{ item.state | default(omit) }}"
  with_items: "{{ users }}"
  become: true
  no_log: true
  tags: users

- name: setup ssh keys
  authorized_key:
    user: "{{ item.0.name }}"
    key: "{{ item.1 }}"
  with_subelements:
    - "{{ users }}"
    - ssh_authorized_keys
    - skip_missing: true
  become: true
  no_log: true
  tags: users
